<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=google-site-verification content="8_xpI-TS3tNV8UPug-Q6Ef3BhKTcy0WOG7dEdAcm2zk"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="祝融"><link rel=dns-prefetch href=//cdn.jsdelivr.net><link rel=preconnect href=https://cdn.jsdelivr.net crossorigin><link rel=dns-prefetch href=//www.googletagmanager.com><link rel=preconnect href=https://www.googletagmanager.com crossorigin><link rel=canonical href=https://zhurongshuo.com/practices/season-4/ai-engineer-in-action/part-01/chapter-03/><title>祝融说。 第三章：构建AI服务的后端基石</title><meta property="og:title" content="第三章：构建AI服务的后端基石"><meta property="og:url" content="https://zhurongshuo.com/practices/season-4/ai-engineer-in-action/part-01/chapter-03/"><meta property="og:site_name" content="祝融说。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:published_time" content="2025-12-09T00:00:00+08:00"><meta property="article:modified_time" content="2025-12-09T00:00:00+08:00"><meta property="article:tag" content="书稿"><meta name=description content="在前面的章节中，我们修炼了Python的内功，并掌握了数据科学的利器。通过Kaggle实战，我们已经能够从原始数据出发，经过一系列精细的处理和分析，最终训练出一个表现不错的机器学习模型，并将其保存为一个文件（例如.pkl或.pth格式）。
然而，一个孤立的模型文件，无论其内部多么强大，其价值都是有限的。它就像一把铸造好的绝世好剑，却被锁在剑鞘里，无法施展其锋芒。要真正释放AI模型的价值，我们必须将其部署为一个在线服务，让它能够被其他的应用程序、网站、移动端乃至物联网设备所调用，从而赋能万千场景。这个从模型文件到在线服务的过程，就是AI工程化的“最后一公里”。
"><meta property="og:description" content="在前面的章节中，我们修炼了Python的内功，并掌握了数据科学的利器。通过Kaggle实战，我们已经能够从原始数据出发，经过一系列精细的处理和分析，最终训练出一个表现不错的机器学习模型，并将其保存为一个文件（例如.pkl或.pth格式）。
然而，一个孤立的模型文件，无论其内部多么强大，其价值都是有限的。它就像一把铸造好的绝世好剑，却被锁在剑鞘里，无法施展其锋芒。要真正释放AI模型的价值，我们必须将其部署为一个在线服务，让它能够被其他的应用程序、网站、移动端乃至物联网设备所调用，从而赋能万千场景。这个从模型文件到在线服务的过程，就是AI工程化的“最后一公里”。
"><meta property="og:image" content="https://zhurongshuo.com/images/favicon.ico"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="第三章：构建AI服务的后端基石"><meta name=twitter:description content="在前面的章节中，我们修炼了Python的内功，并掌握了数据科学的利器。通过Kaggle实战，我们已经能够从原始数据出发，经过一系列精细的处理和分析，最终训练出一个表现不错的机器学习模型，并将其保存为一个文件（例如.pkl或.pth格式）。
然而，一个孤立的模型文件，无论其内部多么强大，其价值都是有限的。它就像一把铸造好的绝世好剑，却被锁在剑鞘里，无法施展其锋芒。要真正释放AI模型的价值，我们必须将其部署为一个在线服务，让它能够被其他的应用程序、网站、移动端乃至物联网设备所调用，从而赋能万千场景。这个从模型文件到在线服务的过程，就是AI工程化的“最后一公里”。
"><meta name=twitter:image content="https://zhurongshuo.com/images/favicon.ico"><meta name=keywords content="AI工程师实战：从Python基础到LLM应用与性能优化,第三章：构建AI服务的后端基石"><link rel="shortcut icon" href=https://zhurongshuo.com/images/favicon.ico><link rel=stylesheet type=text/css media=screen href=https://zhurongshuo.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://zhurongshuo.com/css/animate-custom.css><link rel=stylesheet type=text/css media=screen href=https://zhurongshuo.com/css/zozo.css><link rel=stylesheet type=text/css media=screen href=https://zhurongshuo.com/css/remixicon-custom.css><link rel=stylesheet type=text/css media=screen href=https://zhurongshuo.com/css/highlight.css><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"第三章：构建AI服务的后端基石","description":"在前面的章节中，我们修炼了Python的内功，并掌握了数据科学的利器。通过Kaggle实战，我们已经能够从原始数据出发，经过一系列精细的处理和分析，最终训练出一个表现不错的机器学习模型，并将其保存为一个文件（例如.pkl或.pth格式）。\n然而，一个孤立的模型文件，无论其内部多么强大，其价值都是有限的。它就像一把铸造好的绝世好剑，却被锁在剑鞘里，无法施展其锋芒。要真正释放AI模型的价值，我们必须将其部署为一个在线服务，让它能够被其他的应用程序、网站、移动端乃至物联网设备所调用，从而赋能万千场景。这个从模型文件到在线服务的过程，就是AI工程化的“最后一公里”。\n","datePublished":"2025-12-09T00:00:00\u002b08:00","dateModified":"2025-12-09T00:00:00\u002b08:00","author":{"@type":"Person","name":"祝融"},"publisher":{"@type":"Organization","name":"祝融说。","logo":{"@type":"ImageObject","url":"https:\/\/zhurongshuo.com\/images\/favicon.ico"}},"image":"https:\/\/zhurongshuo.com\/images\/favicon.ico","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/zhurongshuo.com\/practices\/season-4\/ai-engineer-in-action\/part-01\/chapter-03\/"},"keywords":"书稿"}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"首页","item":"https:\/\/zhurongshuo.com\/"},{"@type":"ListItem","position":2,"name":"practices","item":"https:\/\/zhurongshuo.com\/practices/"},{"@type":"ListItem","position":3,"name":"第三章：构建AI服务的后端基石","item":"https:\/\/zhurongshuo.com\/practices\/season-4\/ai-engineer-in-action\/part-01\/chapter-03\/"}]}</script></head><body><div class="main animate__animated animate__fadeInDown"><div class="nav_container animated fadeInDown"><div class=site_nav id=site_nav><ul><li><a href=https://zhurongshuo.com/>首页</a></li><li><a href=https://zhurongshuo.com/start/>开始</a></li><li><a href=https://zhurongshuo.com/advanced/>进阶rc</a></li><li><a href=https://zhurongshuo.com/posts/>归档</a></li><li><a href=https://zhurongshuo.com/tags/>标签</a></li><li><a href=https://zhurongshuo.com/about/>关于</a></li></ul></div><div class=menu_icon><a id=menu_icon><i class=ri-menu-line></i></a></div></div><div class="header animated fadeInDown"><div class=site_title_container><div class=site_title><h1><a href=https://zhurongshuo.com/><span class=web-font>祝融说。</span></a></h1></div><div class=description><p class=sub_title>法不净空，觉无性也。</p><div class=my_socials><a href=https://zhurongshuo.com/books/ title=book-open><i class=ri-book-open-line></i></a>
<a href=https://zhurongshuo.com/practices/ title=trophy><i class=ri-trophy-line></i></a>
<a href=https://zhurongshuo.com/gallery/ title=gallery><i class=ri-gallery-line></i></a>
<a href=https://zhurongshuo.com/about/ title=game><i class=ri-game-line></i></a>
<a href type=application/rss+xml title=rss target=_blank><i class=ri-rss-fill></i></a></div></div></div></div><div class=content><div class=post_page><div class="post animate__animated animate__fadeInDown"><div class="post_title post_detail_title"><h2><a href=https://zhurongshuo.com/practices/season-4/ai-engineer-in-action/part-01/chapter-03/>第三章：构建AI服务的后端基石</a></h2><span class=date>2025.12.09</span></div><div class="post_content markdown"><p>在前面的章节中，我们修炼了Python的内功，并掌握了数据科学的利器。通过Kaggle实战，我们已经能够从原始数据出发，经过一系列精细的处理和分析，最终训练出一个表现不错的机器学习模型，并将其保存为一个文件（例如<code>.pkl</code>或<code>.pth</code>格式）。</p><p>然而，一个孤立的模型文件，无论其内部多么强大，其价值都是有限的。它就像一把铸造好的绝世好剑，却被锁在剑鞘里，无法施展其锋芒。要真正释放AI模型的价值，我们必须将其部署为一个在线服务，让它能够被其他的应用程序、网站、移动端乃至物联网设备所调用，从而赋能万千场景。这个从模型文件到在线服务的过程，就是AI工程化的“最后一公里”。</p><p>跨越这“最后一公里”，意味着AI工程师的角色需要从“炼丹师”向“架构师”转变。我们不仅要关心模型的准确率，更要关心服务的可用性（Availability）、响应延迟（Latency）、吞吐量（Throughput）和可扩展性（Scalability）。一个在Jupyter Notebook里运行完美的模型，如果封装成的API服务在100个并发请求下就崩溃，那么它在商业上就是失败的。</p><p>本章，我们将聚焦于构建AI服务的后端基石。我们将学习：</p><p>Flask：一个轻量级、灵活的Python Web框架。它如同一个精巧的“剑鞘”，能让我们快速地将AI模型封装成一个Web API，对外提供能力。我们将学习如何定义路由、处理HTTP请求和响应。</p><p>RESTful API设计：API是服务之间沟通的语言。我们将学习RESTful的设计原则，这是一种业界广泛采纳的、优雅而强大的API设计风格，它能让我们的服务接口清晰、易懂、易于协作。</p><p>Celery：AI模型的推理，特别是对于复杂的深度学习模型，可能是非常耗时的。如果让用户在发起请求后一直等待，会带来极差的体验。Celery是一个强大的分布式任务队列，它如同一个“缓冲池”和“加速器”，能让我们将耗时的AI计算作为异步任务在后台处理，从而让API服务能够瞬间响应，极大地提升用户体验和系统吞吐量。</p><p>最后，我们将通过一个贯穿始终的实战项目——搭建一个支持异步推理的图像分类API服务——将所有知识点融会贯-通。我们将亲手编写代码，将一个预训练好的图像分类模型，从一个本地文件，一步步打造成一个功能完备、支持高并发的在线AI服务。</p><p>掌握本章内容，你将具备将算法模型产品化的核心工程能力，这是区分一名“算法研究员”和一名“AI应用工程师”的关键所在。现在，让我们开始为我们的AI模型，构建一个坚实而高效的“家”。</p><h2 id=31-flask入门快速构建轻量级api服务>3.1 Flask入门：快速构建轻量级API服务</h2><p>在Python的Web框架世界里，Django和Flask是最耀眼的双子星。Django是一个“大而全”的框架，自带ORM、后台管理等众多组件，适合构建复杂的大型Web应用。而Flask则是一个“微框架”（Microframework），它核心精简，只保留了Web开发最基本的功能：路由和请求响应处理。这种极简主义的设计哲学，赋予了Flask极高的灵活性和可扩展性，使其成为构建API服务，特别是AI模型API的理想选择。</p><h3 id=311-hello-ai-world你的第一个flask应用>3.1.1 “Hello, AI World!”：你的第一个Flask应用</h3><p>安装Flask非常简单：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip install Flask
</span></span></code></pre></div><p>现在，让我们用最少的代码来创建一个Web服务。新建一个文件 <code>app.py</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># app.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. 创建一个Flask应用实例</span>
</span></span><span class=line><span class=cl><span class=c1># __name__ 是一个Python预定义的变量，它指向当前模块的名字。</span>
</span></span><span class=line><span class=cl><span class=c1># Flask用它来确定应用的根目录，以便找到模板和静态文件。</span>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 定义一个路由（Route）和视图函数（View Function）</span>
</span></span><span class=line><span class=cl><span class=c1># @app.route(&#39;/&#39;) 是一个装饰器，它告诉Flask，当用户访问网站的根URL(&#39;/&#39;)时，</span>
</span></span><span class=line><span class=cl><span class=c1># 应该调用下面的 home 函数。</span>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>home</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># 3. 视图函数返回的内容，就是用户在浏览器中看到的内容。</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;Hello, AI World!&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 启动Web服务器</span>
</span></span><span class=line><span class=cl><span class=c1># 这段代码确保只有在直接运行这个脚本时，服务器才会启动。</span>
</span></span><span class=line><span class=cl><span class=c1># 如果这个文件被其他文件导入，服务器不会启动。</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># app.run() 会启动一个内置的、用于开发的Web服务器。</span>
</span></span><span class=line><span class=cl>    <span class=c1># debug=True 会开启调试模式，当代码有改动时服务器会自动重启，</span>
</span></span><span class=line><span class=cl>    <span class=c1># 并且在出错时会显示详细的错误信息。生产环境中切勿开启！</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>debug</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span></code></pre></div><p>在终端中运行这个文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python app.py
</span></span></code></pre></div><p>你会看到类似下面的输出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl> * Serving Flask app &#39;app&#39;
</span></span><span class=line><span class=cl> * Debug mode: on
</span></span><span class=line><span class=cl> * Running on http://127.0.0.1:5000
</span></span></code></pre></div><p>现在，打开你的浏览器，访问 <code>http://127.0.0.1:5000</code>，你将看到页面上显示的 "Hello, AI World!"。恭喜你，你已经成功构建并运行了你的第一个Web服务！</p><h3 id=312-路由请求与响应web服务的核心交互>3.1.2 路由、请求与响应：Web服务的核心交互</h3><p>Web服务的本质，就是接收客户端（如浏览器、手机App）发来的请求（Request），经过处理后，返回一个响应（Response）。</p><p>动态路由（Dynamic Routes）</p><p>我们可以让URL的一部分是可变的，从而处理更复杂的请求。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ... (接上文) ...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># &lt;username&gt; 是一个变量，Flask会捕获URL中这部分的值，并作为参数传给视图函数。</span>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/user/&lt;username&gt;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show_user_profile</span><span class=p>(</span><span class=n>username</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;User: </span><span class=si>{</span><span class=n>username</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 还可以指定变量的类型，例如 &lt;int:post_id&gt;</span>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/post/&lt;int:post_id&gt;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show_post</span><span class=p>(</span><span class=n>post_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Post ID: </span><span class=si>{</span><span class=n>post_id</span><span class=si>}</span><span class=s2>, Type: </span><span class=si>{</span><span class=nb>type</span><span class=p>(</span><span class=n>post_id</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span></code></pre></div><p>现在访问 <code>http://127.0.0.1:5000/user/Alice</code>，会看到 "User: Alice"。
访问 <code>http://127.0.0.1:5000/post/123</code>，会看到 "Post ID: 123, Type: &lt;class 'int'>"`。</p><p>HTTP方法（HTTP Methods）</p><p>Web通信主要使用不同的HTTP方法来表达操作的意图。对于API服务，最常用的是：</p><p><code>GET</code>：获取资源。</p><p><code>POST</code>：创建或提交资源（通常带有数据体）。</p><p><code>PUT</code>：更新资源。</p><p><code>DELETE</code>：删除资源。</p><p>默认情况下，Flask的路由只响应<code>GET</code>请求。我们可以通过 <code>methods</code> 参数来指定。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>request</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/predict&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>predict</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;POST&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 处理POST请求，通常是接收数据并进行模型推理</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;Received a POST request. Ready to predict!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 处理GET请求，可以返回一个说明页面</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;This is the prediction endpoint. Please use POST to submit data.&#34;</span>
</span></span></code></pre></div><p>请求对象（Request Object）</p><p>Flask将客户端发来的所有信息都封装在了全局的 <code>request</code> 对象中。我们可以从中获取：</p><p><code>request.method</code>：请求的方法（'GET', 'POST'等）。</p><p><code>request.args</code>：获取URL查询参数（例如 <code>/search?query=flask</code> 中的 <code>query</code>）。</p><p><code>request.form</code>：获取POST请求中表单数据。</p><p><code>request.json</code>：如果请求的<code>Content-Type</code>是<code>application/json</code>，可以直接获取解析后的JSON数据。这是现代API最常用的数据交换方式。</p><p><code>request.files</code>：获取上传的文件。</p><p>响应（Response）</p><p>视图函数不仅可以返回字符串，还可以返回更复杂的响应。最常用的是返回JSON格式的数据，这需要用到 <code>jsonify</code> 函数。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>jsonify</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/api/model/info&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>model_info</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;model_name&#34;</span><span class=p>:</span> <span class=s2>&#34;ImageClassifier_ResNet50&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;input_type&#34;</span><span class=p>:</span> <span class=s2>&#34;image/jpeg&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;output_type&#34;</span><span class=p>:</span> <span class=s2>&#34;json&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1># jsonify 会将Python字典转换为JSON格式的响应，</span>
</span></span><span class=line><span class=cl>    <span class=c1># 并设置正确的Content-Type头 (application/json)。</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>jsonify</span><span class=p>(</span><span class=n>info</span><span class=p>)</span>
</span></span></code></pre></div><p>访问 <code>http://127.0.0.1:5000/api/model/info</code>，你将看到一个格式化的JSON响应。</p><h3 id=313-将ai模型集成到flask中>3.1.3 将AI模型集成到Flask中</h3><p>现在，让我们来做一个简单的模型集成。假设我们有一个用Scikit-learn训练好的鸢尾花分类模型。</p><ol><li><p>训练并保存模型（一次性操作）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># scripts/train_iris_model.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.datasets</span> <span class=kn>import</span> <span class=n>load_iris</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.linear_model</span> <span class=kn>import</span> <span class=n>LogisticRegression</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pickle</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>iris</span> <span class=o>=</span> <span class=n>load_iris</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>X</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=n>iris</span><span class=o>.</span><span class=n>data</span><span class=p>,</span> <span class=n>iris</span><span class=o>.</span><span class=n>target</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>LogisticRegression</span><span class=p>(</span><span class=n>max_iter</span><span class=o>=</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>model</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用pickle将训练好的模型对象序列化到文件</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;iris_model.pkl&#39;</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>pickle</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>f</span><span class=p>)</span>
</span></span></code></pre></div></li><li><p>在Flask应用中加载并使用模型</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># app.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>jsonify</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pickle</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在应用启动时，加载一次模型到内存中</span>
</span></span><span class=line><span class=cl><span class=c1># 避免每次请求都重新加载，提高效率</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;iris_model.pkl&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span> <span class=o>=</span> <span class=n>pickle</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iris_target_names</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;setosa&#39;</span><span class=p>,</span> <span class=s1>&#39;versicolor&#39;</span><span class=p>,</span> <span class=s1>&#39;virginica&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;模型加载成功！&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>FileNotFoundError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;错误：找不到模型文件 &#39;iris_model.pkl&#39;。请先运行训练脚本。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>home</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;鸢尾花分类API。请POST到 /predict 端点。&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/predict&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>predict</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>model</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;模型未加载，服务不可用&#34;</span><span class=p>}),</span> <span class=mi>500</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 1. 获取并校验输入数据</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>get_json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>data</span> <span class=ow>or</span> <span class=s1>&#39;features&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;请求体必须是包含 &#39;features&#39; 键的JSON&#34;</span><span class=p>}),</span> <span class=mi>400</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>features</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;features&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>features</span><span class=p>,</span> <span class=nb>list</span><span class=p>)</span> <span class=ow>or</span> <span class=nb>len</span><span class=p>(</span><span class=n>features</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>4</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;&#39;features&#39; 必须是一个包含4个数值的列表&#34;</span><span class=p>}),</span> <span class=mi>400</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 2. 数据预处理</span>
</span></span><span class=line><span class=cl>        <span class=c1># 将输入的列表转换为Numpy数组，并reshape成模型需要的(1, 4)形状</span>
</span></span><span class=line><span class=cl>        <span class=n>input_data</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>features</span><span class=p>)</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 3. 模型推理</span>
</span></span><span class=line><span class=cl>        <span class=n>prediction_idx</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>input_data</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>prediction_name</span> <span class=o>=</span> <span class=n>iris_target_names</span><span class=p>[</span><span class=n>prediction_idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>probabilities</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict_proba</span><span class=p>(</span><span class=n>input_data</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>confidence</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>iris_target_names</span><span class=p>,</span> <span class=n>probabilities</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 4. 构造响应</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;prediction&#34;</span><span class=p>:</span> <span class=n>prediction_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;class_index&#34;</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>prediction_idx</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;confidence&#34;</span><span class=p>:</span> <span class=n>confidence</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 捕获潜在的错误，例如输入数据无法转换为数值</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;处理请求时发生错误: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>}),</span> <span class=mi>500</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>debug</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span></code></pre></div><p>现在，你可以使用 <code>curl</code> 或 Postman 等工具来测试这个API：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -X POST http://127.0.0.1:5000/predict <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-H <span class=s2>&#34;Content-Type: application/json&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-d <span class=s1>&#39;{&#34;features&#34;: [5.1, 3.5, 1.4, 0.2]}&#39;</span>
</span></span></code></pre></div><p>你会收到一个类似这样的JSON响应：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;class_index&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;confidence&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;setosa&#34;</span><span class=p>:</span> <span class=mf>0.98</span><span class=err>...</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;versicolor&#34;</span><span class=p>:</span> <span class=mf>0.01</span><span class=err>...</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;virginica&#34;</span><span class=p>:</span> <span class=mf>0.0</span><span class=err>...</span>
</span></span><span class=line><span class=cl><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;prediction&#34;</span><span class=p>:</span> <span class=s2>&#34;setosa&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这个例子虽然简单，但它包含了构建一个AI API的完整流程：加载模型 -> 定义API端点 -> 接收和校验数据 -> 预处理 -> 模型推理 -> 格式化响应。</p></li></ol><h2 id=32-restful-api设计原则与最佳实践>3.2 RESTful API设计原则与最佳实践</h2><p>我们刚刚构建了一个能工作的API，但要让它成为一个“好”的API，就需要遵循一定的设计规范。REST（Representational State Transfer）是一种软件架构风格，而不是一个严格的协议。基于REST构建的API，我们称之为RESTful API。</p><h3 id=321-核心原则>3.2.1 核心原则</h3><ol><li><p>资源（Resources）：API的核心是“资源”。任何事物都可以是资源，例如一个用户、一张图片、一个模型预测结果。每个资源都由一个唯一的URI（Uniform Resource Identifier）来标识，通常是URL。</p><ul><li>坏实践: <code>/getUser?id=123</code>, <code>/createPrediction</code></li><li>好实践: <code>/users/123</code>, <code>/predictions</code></li></ul></li><li><p>使用HTTP方法表达操作：对资源的操作，应该由HTTP方法来定义。</p><ul><li><code>GET /users/123</code>：获取ID为123的用户信息。</li><li><code>POST /users</code>：创建一个新用户。</li><li><code>PUT /users/123</code>：更新ID为123的用户信息。</li><li><code>DELETE /users/123</code>：删除ID为123的用户。</li></ul><p>URL中应使用名词，而不是动词。</p></li><li><p>使用HTTP状态码表达结果：API的响应应该使用标准的HTTP状态码来告知客户端操作的结果。</p><p>2xx（成功）:</p><ul><li><code>200 OK</code>：请求成功。</li><li><code>201 Created</code>：资源创建成功。</li><li><code>204 No Content</code>：操作成功，但没有内容返回（例如DELETE）。</li></ul><p>4xx（客户端错误）:</p><ul><li><code>400 Bad Request</code>：请求无效（例如JSON格式错误、参数缺失）。</li><li><code>401 Unauthorized</code>：需要认证。</li><li><code>403 Forbidden</code>：认证成功，但无权限访问。</li><li><code>404 Not Found</code>：资源不存在。</li></ul><p>5xx（服务器错误）:</p><ul><li><code>500 Internal Server Error</code>：服务器内部发生未知错误。</li><li><code>503 Service Unavailable</code>：服务暂时不可用。</li></ul></li><li><p>无状态（Stateless）：服务器不应该保存任何关于客户端会话的状态。每一次请求都应该包含所有必要的信息，使得服务器能够独立处理它。这极大地简化了服务器的设计，并使其易于水平扩展。</p></li></ol><h3 id=322-ai-api设计最佳实践>3.2.2 AI API设计最佳实践</h3><p>版本化（Versioning）：API应该有版本。当你的模型或接口发生不兼容的变更时，可以通过升级版本来避免破坏现有客户端的集成。</p><ul><li>URL版本化: <code>https://api.example.com/v1/predict</code></li><li>Header版本化: 在HTTP头中指定 <code>Accept: application/vnd.example.v1+json</code></li></ul><p>清晰的请求/响应格式：使用JSON作为主要的数据交换格式。请求和响应的JSON结构应该清晰、一致，并有文档说明。</p><p>请求体:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;model_version&#34;</span><span class=p>:</span> <span class=s2>&#34;v1.2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;data&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;image_url&#34;</span><span class=p>:</span> <span class=s2>&#34;http://...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// or &#34;image_base64&#34;: &#34;...&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;parameters&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;top_k&#34;</span><span class=p>:</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>成功响应体:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;request_id&#34;</span><span class=p>:</span> <span class=s2>&#34;xyz-123&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;prediction&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;cat&#34;</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>0.95</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;dog&#34;</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>0.04</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>错误响应体:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;error&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;INVALID_INPUT&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Input image format not supported.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>异步处理模式：对于耗时长的AI任务（例如视频分析、大模型生成），同步等待是不可行的。应该采用异步模式：</p><ol><li><p>客户端 <code>POST /jobs</code> 发起一个任务，请求体包含任务所需数据。</p></li><li><p>服务器立即验证请求，创建一个任务，并返回 <code>202 Accepted</code> 状态码，响应体中包含一个任务ID和查询状态的URL。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;job_id&#34;</span><span class=p>:</span> <span class=s2>&#34;job-abc-456&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;pending&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;status_url&#34;</span><span class=p>:</span> <span class=s2>&#34;/jobs/job-abc-456&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></li><li><p>客户端稍后轮询 <code>GET /jobs/{job_id}</code> 来查询任务状态。</p></li><li><p>当任务完成时，<code>GET</code> 请求会返回 <code>200 OK</code> 和最终的结果。</p></li></ol><p>我们将在下一节学习如何用Celery来实现这种强大的异步模式。</p><h2 id=33-celery用异步任务处理耗时的ai计算>3.3 Celery：用异步任务处理耗时的AI计算</h2><h3 id=331-为什么需要任务队列>3.3.1 为什么需要任务队列？</h3><p>回到我们的Flask API。当一个<code>POST /predict</code>请求进来时，<code>predict</code>函数会执行模型推理。如果这个推理过程需要5秒钟，那么这个HTTP连接就会被占用5秒钟，客户端会一直处于等待状态。更糟糕的是，Flask的开发服务器是单线程的，这意味着在这5秒内，它无法处理任何其他请求。</p><p>在生产环境中，我们会使用Gunicorn等多进程/多线程的WSGI服务器，但这并不能从根本上解决问题。如果同时有10个请求进来，每个都需要5秒，那么服务器的10个工作进程（worker）都会被占满，第11个请求就必须排队等待。这会导致系统吞吐量极低，且用户体验极差。</p><p>Celery引入了任务队列（Task Queue）的架构来解决这个问题。其核心组件包括：</p><ol><li>生产者（Producer）：我们的Flask应用。它不直接执行耗时任务，而是将任务描述（例如“请对这张图片进行分类”）发送到一个消息队列中。</li><li>消息中间件（Message Broker）：一个消息队列，如 Redis 或 RabbitMQ。它像一个任务的“待办清单”，负责接收和存储生产者发来的任务。</li><li>消费者（Consumer），也叫 Worker：一个或多个独立的Celery进程。它们持续地从Broker那里获取任务，并在后台执行这些任务。Worker和Flask应用是完全解耦的，可以部署在不同的机器上。</li><li>结果后端（Result Backend）：一个用于存储任务执行结果的数据库，如 Redis 或数据库。这使得Flask应用可以稍后查询任务的状态和结果。</li></ol><p>工作流程：</p><ol><li>Flask API接收到请求，立即将一个推理任务（包含图片数据）发送给Redis。</li><li>Flask API立刻向客户端返回一个“任务已接收”的响应，包含一个任务ID。整个HTTP请求-响应周期可能只需要几十毫秒。</li><li>在后台，一个空闲的Celery Worker从Redis中取出该任务。</li><li>Worker执行耗时的模型推理。</li><li>Worker将推理结果存入Redis结果后端。</li><li>客户端使用任务ID，通过另一个API端点来查询任务状态，最终获取结果。</li></ol><p>这种架构带来了巨大的好处：</p><ul><li>高响应性：API几乎是瞬间响应的。</li><li>高吞吐量：API可以快速处理大量请求，因为它的主要工作只是把任务丢进队列。</li><li>可扩展性：如果任务积压，我们只需要增加更多的Celery Worker进程或机器，而无需改动Flask应用。</li><li>解耦与健壮性：即使Worker因为某个任务崩溃了，也不会影响到主Web应用。</li></ul><h3 id=332-celery与flask集成>3.3.2 Celery与Flask集成</h3><p>安装所需库：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip install celery redis
</span></span></code></pre></div><p>你还需要安装并运行一个Redis服务器。使用Docker是最简单的方式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -d -p 6379:6379 --name my-redis redis
</span></span></code></pre></div><p>项目结构调整：</p><p>为了更好地组织代码，我们将创建一个应用工厂模式的Flask项目。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>async_image_classifier/
</span></span><span class=line><span class=cl>├── app/
</span></span><span class=line><span class=cl>│   ├── __init__.py       # 应用工厂
</span></span><span class=line><span class=cl>│   ├── tasks.py          # Celery任务定义
</span></span><span class=line><span class=cl>│   └── routes.py         # Flask路由定义
</span></span><span class=line><span class=cl>├── celery_worker.py      # 启动Celery worker的脚本
</span></span><span class=line><span class=cl>├── config.py             # 配置文件
</span></span><span class=line><span class=cl>└── run.py                # 启动Flask应用的脚本
</span></span></code></pre></div><ol><li><p>配置文件 (<code>config.py</code>)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Config</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>CELERY_BROKER_URL</span> <span class=o>=</span> <span class=s1>&#39;redis://localhost:6379/0&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>CELERY_RESULT_BACKEND</span> <span class=o>=</span> <span class=s1>&#39;redis://localhost:6379/0&#39;</span>
</span></span></code></pre></div></li><li><p>创建Celery实例和Flask应用工厂 (<code>app/__init__.py</code>)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>celery</span> <span class=kn>import</span> <span class=n>Celery</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>config</span> <span class=kn>import</span> <span class=n>Config</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建Celery实例，但尚未配置</span>
</span></span><span class=line><span class=cl><span class=n>celery</span> <span class=o>=</span> <span class=n>Celery</span><span class=p>(</span><span class=vm>__name__</span><span class=p>,</span> <span class=n>broker</span><span class=o>=</span><span class=n>Config</span><span class=o>.</span><span class=n>CELERY_BROKER_URL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_app</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>from_object</span><span class=p>(</span><span class=n>Config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 将Flask的配置更新到Celery实例中</span>
</span></span><span class=line><span class=cl>    <span class=n>celery</span><span class=o>.</span><span class=n>conf</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 注册路由</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>.</span> <span class=kn>import</span> <span class=n>routes</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>register_blueprint</span><span class=p>(</span><span class=n>routes</span><span class=o>.</span><span class=n>bp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>app</span>
</span></span></code></pre></div></li><li><p>定义Celery任务 (<code>app/tasks.py</code>)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>.</span> <span class=kn>import</span> <span class=n>celery</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 这是一个模拟的耗时AI任务</span>
</span></span><span class=line><span class=cl><span class=nd>@celery.task</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>long_running_ai_task</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;模拟一个需要5秒钟的AI计算任务&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;开始处理任务，接收到数据: </span><span class=si>{</span><span class=n>data</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=n>data</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;This is the prediction result.&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;任务处理完成。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span>
</span></span></code></pre></div><p><code>@celery.task</code> 装饰器将一个普通函数转换为了一个Celery任务。</p></li><li><p>定义Flask路由 (<code>app/routes.py</code>)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Blueprint</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>jsonify</span><span class=p>,</span> <span class=n>url_for</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>.tasks</span> <span class=kn>import</span> <span class=n>long_running_ai_task</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>bp</span> <span class=o>=</span> <span class=n>Blueprint</span><span class=p>(</span><span class=s1>&#39;main&#39;</span><span class=p>,</span> <span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@bp.route</span><span class=p>(</span><span class=s1>&#39;/start-task&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start_task</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>get_json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;No data provided&#34;</span><span class=p>}),</span> <span class=mi>400</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 异步地调用任务</span>
</span></span><span class=line><span class=cl>    <span class=c1># .delay() 是 .apply_async() 的快捷方式</span>
</span></span><span class=line><span class=cl>    <span class=n>task</span> <span class=o>=</span> <span class=n>long_running_ai_task</span><span class=o>.</span><span class=n>delay</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 立即返回，并提供一个查询状态的URL</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Task started&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;task_id&#34;</span><span class=p>:</span> <span class=n>task</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;status_url&#34;</span><span class=p>:</span> <span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;main.task_status&#39;</span><span class=p>,</span> <span class=n>task_id</span><span class=o>=</span><span class=n>task</span><span class=o>.</span><span class=n>id</span><span class=p>,</span> <span class=n>_external</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}),</span> <span class=mi>202</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@bp.route</span><span class=p>(</span><span class=s1>&#39;/task-status/&lt;task_id&gt;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>task_status</span><span class=p>(</span><span class=n>task_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>task</span> <span class=o>=</span> <span class=n>long_running_ai_task</span><span class=o>.</span><span class=n>AsyncResult</span><span class=p>(</span><span class=n>task_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;task_id&#34;</span><span class=p>:</span> <span class=n>task_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=n>task</span><span class=o>.</span><span class=n>state</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>task</span><span class=o>.</span><span class=n>state</span> <span class=o>==</span> <span class=s1>&#39;PENDING&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=p>[</span><span class=s1>&#39;info&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;Task is waiting to be executed.&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>task</span><span class=o>.</span><span class=n>state</span> <span class=o>==</span> <span class=s1>&#39;SUCCESS&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>task</span><span class=o>.</span><span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>task</span><span class=o>.</span><span class=n>state</span> <span class=o>!=</span> <span class=s1>&#39;FAILURE&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 任务正在进行中</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=p>[</span><span class=s1>&#39;info&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>task</span><span class=o>.</span><span class=n>info</span> <span class=ow>or</span> <span class=s1>&#39;No progress info&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 任务失败</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=p>[</span><span class=s1>&#39;info&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>task</span><span class=o>.</span><span class=n>info</span><span class=p>)</span> <span class=c1># 异常信息</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>jsonify</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span></code></pre></div></li><li><p>启动脚本 (<code>run.py</code> 和 <code>celery_worker.py</code>)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># run.py (启动Flask)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>app</span> <span class=kn>import</span> <span class=n>create_app</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>create_app</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>debug</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># celery_worker.py (启动Celery)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>app</span> <span class=kn>import</span> <span class=n>create_app</span><span class=p>,</span> <span class=n>celery</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>create_app</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>app_context</span><span class=p>()</span><span class=o>.</span><span class=n>push</span><span class=p>()</span>
</span></span></code></pre></div></li></ol><p>运行：</p><p>你需要打开两个终端窗口。</p><p>终端1（启动Celery Worker）:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># -A 指定Celery应用实例的位置</span>
</span></span><span class=line><span class=cl><span class=c1># -l info 设置日志级别</span>
</span></span><span class=line><span class=cl>celery -A celery_worker.celery worker -l info
</span></span></code></pre></div><p>终端2（启动Flask应用）:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python run.py
</span></span></code></pre></div><p>现在，你可以像之前一样用<code>curl</code>来测试了：</p><ol><li><p>发起任务:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -X POST http://127.0.0.1:5000/start-task -H <span class=s2>&#34;Content-Type: application/json&#34;</span> -d <span class=s1>&#39;{&#34;image_id&#34;: 123}&#39;</span>
</span></span></code></pre></div><p>你会立即收到一个包含<code>task_id</code>的响应。</p></li><li><p>查询状态:</p><p>复制上一步返回的<code>task_id</code>，然后访问状态URL：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://127.0.0.1:5000/task-status/your-task-id-here
</span></span></code></pre></div><p>一开始，状态可能是<code>PENDING</code>或<code>STARTED</code>。等待5秒后，再次查询，状态会变为<code>SUCCESS</code>，并且你会看到任务的返回结果。</p></li></ol><p>至此，我们已经成功地搭建了一个完整的异步任务处理系统！</p><h2 id=34-实战项目搭建一个支持异步推理的图像分类api服务>3.4 实战项目：搭建一个支持异步推理的图像分类API服务</h2><p>现在，我们将把本章所有知识点整合起来，完成我们的最终项目。我们将使用一个预训练的深度学习模型（例如ResNet50），通过Flask和Celery，将其部署为一个功能完备的、异步的图像分类服务。</p><p>项目目标：</p><ol><li>提供一个 <code>/predict</code> 端点，接收上传的图像文件。</li><li>该端点应立即响应，返回一个任务ID。</li><li>后台Celery Worker负责图像的预处理和模型推理。</li><li>提供一个 <code>/results/&lt;task_id></code> 端点，用于查询分类结果。</li></ol><p>技术栈：</p><ul><li>Flask</li><li>Celery + Redis</li><li>PyTorch + TorchVision (用于模型和图像处理)</li><li>Pillow (用于图像I/O)</li></ul><p>安装额外依赖：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip install torch torchvision Pillow
</span></span></code></pre></div><p>项目结构： (与3.3节类似)</p><ol><li><p>定义Celery任务 (<code>app/tasks.py</code>)</p><p>这次是真正的AI任务。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># app/tasks.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>.</span> <span class=kn>import</span> <span class=n>celery</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>PIL</span> <span class=kn>import</span> <span class=n>Image</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torchvision.transforms</span> <span class=k>as</span> <span class=nn>transforms</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torchvision.models</span> <span class=k>as</span> <span class=nn>models</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>io</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --- 模型加载 ---</span>
</span></span><span class=line><span class=cl><span class=c1># 在worker启动时加载一次模型，避免重复加载</span>
</span></span><span class=line><span class=cl><span class=c1># 使用预训练的ResNet50模型</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>resnet50</span><span class=p>(</span><span class=n>weights</span><span class=o>=</span><span class=n>models</span><span class=o>.</span><span class=n>ResNet50_Weights</span><span class=o>.</span><span class=n>DEFAULT</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>model</span><span class=o>.</span><span class=n>eval</span><span class=p>()</span> <span class=c1># 设置为评估模式</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载ImageNet类别标签</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;imagenet_class_index.json&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>class_index</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>imagenet_labels</span> <span class=o>=</span> <span class=p>{</span><span class=nb>int</span><span class=p>(</span><span class=n>k</span><span class=p>):</span> <span class=n>v</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>class_index</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;ImageNet labels loaded.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>FileNotFoundError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Warning: imagenet_class_index.json not found. Predictions will be class indices.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>imagenet_labels</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --- 图像预处理 ---</span>
</span></span><span class=line><span class=cl><span class=c1># 定义与ResNet50训练时相同的预处理流程</span>
</span></span><span class=line><span class=cl><span class=n>preprocess</span> <span class=o>=</span> <span class=n>transforms</span><span class=o>.</span><span class=n>Compose</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=n>transforms</span><span class=o>.</span><span class=n>Resize</span><span class=p>(</span><span class=mi>256</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>transforms</span><span class=o>.</span><span class=n>CenterCrop</span><span class=p>(</span><span class=mi>224</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>transforms</span><span class=o>.</span><span class=n>ToTensor</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>transforms</span><span class=o>.</span><span class=n>Normalize</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=p>[</span><span class=mf>0.485</span><span class=p>,</span> <span class=mf>0.456</span><span class=p>,</span> <span class=mf>0.406</span><span class=p>],</span> <span class=n>std</span><span class=o>=</span><span class=p>[</span><span class=mf>0.229</span><span class=p>,</span> <span class=mf>0.224</span><span class=p>,</span> <span class=mf>0.225</span><span class=p>]),</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@celery.task</span><span class=p>(</span><span class=n>bind</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>classify_image_task</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>image_b64_string</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Celery任务：解码图像，预处理，进行模型推理。
</span></span></span><span class=line><span class=cl><span class=s2>    bind=True 可以让任务函数访问self，从而可以更新任务状态。
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>update_state</span><span class=p>(</span><span class=n>state</span><span class=o>=</span><span class=s1>&#39;PROGRESS&#39;</span><span class=p>,</span> <span class=n>meta</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;Decoding image...&#39;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=c1># 解码Base64字符串为图像</span>
</span></span><span class=line><span class=cl>        <span class=n>image_bytes</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>image_b64_string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>BytesIO</span><span class=p>(</span><span class=n>image_bytes</span><span class=p>))</span><span class=o>.</span><span class=n>convert</span><span class=p>(</span><span class=s1>&#39;RGB&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>update_state</span><span class=p>(</span><span class=n>state</span><span class=o>=</span><span class=s1>&#39;PROGRESS&#39;</span><span class=p>,</span> <span class=n>meta</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;Preprocessing image...&#39;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=c1># 预处理图像</span>
</span></span><span class=line><span class=cl>        <span class=n>input_tensor</span> <span class=o>=</span> <span class=n>preprocess</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>input_batch</span> <span class=o>=</span> <span class=n>input_tensor</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=c1># 创建一个mini-batch</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>update_state</span><span class=p>(</span><span class=n>state</span><span class=o>=</span><span class=s1>&#39;PROGRESS&#39;</span><span class=p>,</span> <span class=n>meta</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;Running model inference...&#39;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=c1># 模型推理</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>no_grad</span><span class=p>():</span> <span class=c1># 关闭梯度计算，加速推理</span>
</span></span><span class=line><span class=cl>            <span class=n>output</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=n>input_batch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 获取Top 5预测结果</span>
</span></span><span class=line><span class=cl>        <span class=n>probabilities</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>nn</span><span class=o>.</span><span class=n>functional</span><span class=o>.</span><span class=n>softmax</span><span class=p>(</span><span class=n>output</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>dim</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>top5_prob</span><span class=p>,</span> <span class=n>top5_catid</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>topk</span><span class=p>(</span><span class=n>probabilities</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>update_state</span><span class=p>(</span><span class=n>state</span><span class=o>=</span><span class=s1>&#39;PROGRESS&#39;</span><span class=p>,</span> <span class=n>meta</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;Formatting results...&#39;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>top5_prob</span><span class=o>.</span><span class=n>size</span><span class=p>(</span><span class=mi>0</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>prob</span> <span class=o>=</span> <span class=n>top5_prob</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>item</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>cat_id</span> <span class=o>=</span> <span class=n>top5_catid</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>item</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>label</span> <span class=o>=</span> <span class=n>imagenet_labels</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>cat_id</span><span class=p>,</span> <span class=s2>&#34;Unknown&#34;</span><span class=p>)</span> <span class=k>if</span> <span class=n>imagenet_labels</span> <span class=k>else</span> <span class=s2>&#34;Unknown&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=n>label</span><span class=p>,</span> <span class=s2>&#34;probability&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>prob</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;Completed&#39;</span><span class=p>,</span> <span class=s1>&#39;predictions&#39;</span><span class=p>:</span> <span class=n>results</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>update_state</span><span class=p>(</span><span class=n>state</span><span class=o>=</span><span class=s1>&#39;FAILURE&#39;</span><span class=p>,</span> <span class=n>meta</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;exc_type&#39;</span><span class=p>:</span> <span class=nb>type</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span> <span class=s1>&#39;exc_message&#39;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)})</span>
</span></span><span class=line><span class=cl>        <span class=c1># 在Celery中，最好是抛出异常，而不是返回错误信息</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>e</span>
</span></span></code></pre></div><p><em>注意：你需要从网上下载 <code>imagenet_class_index.json</code> 文件并放在项目根目录。</em></p></li><li><p>定义Flask路由 (<code>app/routes.py</code>)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># app/routes.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Blueprint</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>jsonify</span><span class=p>,</span> <span class=n>url_for</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>.tasks</span> <span class=kn>import</span> <span class=n>classify_image_task</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>bp</span> <span class=o>=</span> <span class=n>Blueprint</span><span class=p>(</span><span class=s1>&#39;main&#39;</span><span class=p>,</span> <span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@bp.route</span><span class=p>(</span><span class=s1>&#39;/predict&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>predict</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;image&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>request</span><span class=o>.</span><span class=n>files</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;No image file provided in the request&#34;</span><span class=p>}),</span> <span class=mi>400</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>file</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>files</span><span class=p>[</span><span class=s1>&#39;image&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 检查文件类型 (可选但推荐)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>file</span><span class=o>.</span><span class=n>filename</span> <span class=o>==</span> <span class=s1>&#39;&#39;</span> <span class=ow>or</span> <span class=ow>not</span> <span class=n>file</span><span class=o>.</span><span class=n>filename</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=o>.</span><span class=n>endswith</span><span class=p>((</span><span class=s1>&#39;.png&#39;</span><span class=p>,</span> <span class=s1>&#39;.jpg&#39;</span><span class=p>,</span> <span class=s1>&#39;.jpeg&#39;</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;Invalid file type. Please upload a PNG, JPG, or JPEG image.&#34;</span><span class=p>}),</span> <span class=mi>400</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 读取文件内容并编码为Base64字符串</span>
</span></span><span class=line><span class=cl>        <span class=c1># 这是将二进制数据通过JSON安全传输的常用方法</span>
</span></span><span class=line><span class=cl>        <span class=n>image_bytes</span> <span class=o>=</span> <span class=n>file</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>image_b64_string</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>image_bytes</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 发起异步任务</span>
</span></span><span class=line><span class=cl>        <span class=n>task</span> <span class=o>=</span> <span class=n>classify_image_task</span><span class=o>.</span><span class=n>delay</span><span class=p>(</span><span class=n>image_b64_string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Image classification task started.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;task_id&#34;</span><span class=p>:</span> <span class=n>task</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;status_url&#34;</span><span class=p>:</span> <span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;main.get_result&#39;</span><span class=p>,</span> <span class=n>task_id</span><span class=o>=</span><span class=n>task</span><span class=o>.</span><span class=n>id</span><span class=p>,</span> <span class=n>_external</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}),</span> <span class=mi>202</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Failed to start task: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>}),</span> <span class=mi>500</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@bp.route</span><span class=p>(</span><span class=s1>&#39;/results/&lt;task_id&gt;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_result</span><span class=p>(</span><span class=n>task_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>task</span> <span class=o>=</span> <span class=n>classify_image_task</span><span class=o>.</span><span class=n>AsyncResult</span><span class=p>(</span><span class=n>task_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;task_id&#34;</span><span class=p>:</span> <span class=n>task_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=n>task</span><span class=o>.</span><span class=n>state</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>task</span><span class=o>.</span><span class=n>state</span> <span class=o>==</span> <span class=s1>&#39;SUCCESS&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>task</span><span class=o>.</span><span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>task</span><span class=o>.</span><span class=n>state</span> <span class=o>==</span> <span class=s1>&#39;FAILURE&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=p>[</span><span class=s1>&#39;error&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>task</span><span class=o>.</span><span class=n>info</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>task</span><span class=o>.</span><span class=n>state</span> <span class=o>==</span> <span class=s1>&#39;PROGRESS&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=p>[</span><span class=s1>&#39;progress&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>task</span><span class=o>.</span><span class=n>info</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>jsonify</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span></code></pre></div></li><li><p>运行与测试</p><p>启动Celery Worker和Flask应用（同3.3节）。然后使用<code>curl</code>上传一张图片进行测试：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 将 &#39;path/to/your/image.jpg&#39; 替换为你的图片路径</span>
</span></span><span class=line><span class=cl>curl -X POST http://127.0.0.1:5000/predict -F <span class=s2>&#34;image=@path/to/your/image.jpg&#34;</span>
</span></span></code></pre></div><p>你会得到一个任务ID。然后用这个ID去查询结果URL，最终你将看到类似这样的JSON输出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;result&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;predictions&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;golden_retriever&#34;</span><span class=p>,</span> <span class=nt>&#34;probability&#34;</span><span class=p>:</span> <span class=s2>&#34;0.9213&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;Labrador_retriever&#34;</span><span class=p>,</span> <span class=nt>&#34;probability&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0345&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;Completed&#34;</span>
</span></span><span class=line><span class=cl><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;SUCCESS&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;task_id&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></li></ol><h2 id=本章小结>本章小结</h2><p>在本章中，我们完成了从一个本地模型文件到一套功能完备、健壮、可扩展的在线AI服务的关键跨越。</p><p>我们首先学习了使用Flask这个轻量级框架，快速地为我们的AI模型穿上了一层“Web外衣”，让它能够通过HTTP协议与外界沟通。接着，我们深入探讨了RESTful API的设计原则，学会了如何设计出清晰、规范、易于协作的API接口，这是专业软件工程的体现。</p><p>最核心的是，我们引入了Celery和任务队列架构，从根本上解决了AI推理耗时导致的API性能瓶颈问题。通过将计算密集型任务异步化，我们构建的服务不仅能为用户提供“秒回”的极致体验，更具备了在高并发场景下水平扩展的能力。</p><p>最终的实战项目，将所有这些技术点凝聚在了一起。你现在不仅知道如何训练一个模型，更掌握了如何将它部署为一个能产生实际商业价值的、工业级的AI服务。这是你作为一名AI工程师，在职业道路上迈出的至关重要的一步。</p><p>在后续的章节中，我们将继续深入AI工程化的其他领域，例如使用Docker容器化我们的应用，以及探索更高级的AI应用范式。但请始终铭记，本章所学的后端工程基础，将是你未来构建任何复杂AI系统时，都离不开的坚实基石。</p></div><div class=post_footer><div class=meta><div class=info><span class="field tags"><i class=ri-stack-line></i>
<a href=https://zhurongshuo.com/tags/%E4%B9%A6%E7%A8%BF/>书稿</a></span></div></div></div></div><div class=doc_comments></div></div></div></div><a id=back_to_top href=# class=back_to_top><i class=ri-arrow-up-s-line></i></a><footer class=footer><div class=powered_by><a href=https://varkai.com>Designed by VarKai, </a><a href=http://www.gohugo.io/>Proudly published with Hugo,</a></div><div class=footer_slogan><span>法不净空，觉无性也。</span></div><div class=powered_by style=margin-top:10px;font-size:14px><a href=https://zhurongshuo.com/>Copyright © 2010-2025 祝融说 zhurongshuo.com All Rights Reserved.</a></div></footer><script defer src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><link href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.css rel=stylesheet integrity="sha256-7qiTu3a8qjjWtcX9w+f2ulVUZSUdCZFEK62eRlmLmCE=" crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script defer src=https://zhurongshuo.com/js/zozo.js></script><script type=text/javascript async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.8/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"})</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-KKJ5ZEG1NB"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-KKJ5ZEG1NB")</script></body></html>